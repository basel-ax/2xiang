# Image Generation Service

A Go-based service for generating images using the Fusion Brain API with PostgreSQL storage.

## Prerequisites

- Go 1.21 or later
- PostgreSQL database
- Fusion Brain API credentials

## Configuration

1. Copy the example environment file:
```bash
cp .env.example .env
```

2. Edit `.env` and set your configuration:
```env
# Fusion Brain API Configuration
FUSION_BRAIN_API_KEY=your-api-key-here
FUSION_BRAIN_SECRET_KEY=your-secret-key-here

# Image Generation Defaults
DEFAULT_IMAGE_WIDTH=1024
DEFAULT_IMAGE_HEIGHT=1024
DEFAULT_NUM_IMAGES=1
DEFAULT_STYLE=ANIME
DEFAULT_NEGATIVE_PROMPT=worst quality, normal quality, low quality, low res, blurry, text, watermark, logo, banner, extra digits, cropped, jpeg artifacts, signature, username, error, sketch ,duplicate, ugly, monochrome, geometry, mutation, disgusting
DEFAULT_GENERATION_TIMEOUT=300
DEFAULT_CHECK_INTERVAL=2
DEFAULT_MAX_ATTEMPTS=30

# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=your-password-here
DB_NAME=your-database-name
DB_SSL_MODE=disable
DB_MAX_OPEN_CONNS=25
DB_MAX_IDLE_CONNS=25
DB_CONN_MAX_LIFETIME=300 # 5 minutes in seconds
```

## Database Setup

1. Create a PostgreSQL database
2. Run the schema creation script:
```sql
CREATE TABLE IF NOT EXISTS images (
    id SERIAL PRIMARY KEY,
    prompt TEXT NOT NULL,
    uuid TEXT,
    status TEXT NOT NULL DEFAULT 'ReadyToGenerate',
    base64 TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_images_status ON images(status);
CREATE INDEX IF NOT EXISTS idx_images_uuid ON images(uuid);
```

## Starting Image Generation

1. Insert a new image generation request into the database:
```sql
INSERT INTO images (prompt, status) 
VALUES ('a beautiful sunset over mountains', 'ReadyToGenerate');
```

2. Run the application:
```bash
# Basic logging (date and time only)
go run cmd/example/main.go

# Verbose logging (includes file names and line numbers)
go run cmd/example/main.go -verbose
```

The service will automatically:
- Pick up image requests with status 'ReadyToGenerate'
- Send them to the Fusion Brain API
- Monitor the generation progress
- Save the generated images as base64 data
- Update the status accordingly

## Logging

The service provides two logging modes:

1. Basic Logging (default):
   - Shows date and time for each log entry
   - Example: `2024/03/21 15:04:05 Processing image ID 1 with prompt: a beautiful sunset`

2. Verbose Logging (with `-verbose` flag):
   - Shows date, time, file name, and line number
   - Helpful for debugging and development
   - Example: `2024/03/21 15:04:05 main.go:123: Processing image ID 1 with prompt: a beautiful sunset`

Log messages include:
- Service startup and shutdown events
- Database connection status
- Image generation progress
- API request status
- Error conditions with context
- Workflow state changes

## Image Status Flow

The image generation process follows these statuses:
- `ReadyToGenerate`: Initial state when a new image request is inserted
- `Generate`: Image is being generated by the Fusion Brain API
- `Completed`: Generation successful, base64 data is saved
- `Failed`: Generation failed

## Configuration Options

### Image Generation Defaults
- `DEFAULT_IMAGE_WIDTH`: Width of generated images (default: 1024)
- `DEFAULT_IMAGE_HEIGHT`: Height of generated images (default: 1024)
- `DEFAULT_NUM_IMAGES`: Number of images to generate per request (default: 1)
- `DEFAULT_STYLE`: Style of the generated images (default: ANIME)
- `DEFAULT_NEGATIVE_PROMPT`: Negative prompt to avoid unwanted elements
- `DEFAULT_GENERATION_TIMEOUT`: Timeout for generation in seconds (default: 300)
- `DEFAULT_CHECK_INTERVAL`: Interval between status checks in seconds (default: 2)
- `DEFAULT_MAX_ATTEMPTS`: Maximum number of status check attempts (default: 30)

### Database Configuration
- `DB_HOST`: Database host
- `DB_PORT`: Database port
- `DB_USER`: Database user
- `DB_PASSWORD`: Database password
- `DB_NAME`: Database name
- `DB_SSL_MODE`: SSL mode for database connection
- `DB_MAX_OPEN_CONNS`: Maximum number of open connections
- `DB_MAX_IDLE_CONNS`: Maximum number of idle connections
- `DB_CONN_MAX_LIFETIME`: Maximum lifetime of connections in seconds

## Project Structure

```
.
├── cmd/
│   └── example/
│       └── main.go           # Application entry point
├── internal/
│   ├── config/
│   │   └── config.go        # Configuration management
│   ├── domain/
│   │   └── image.go         # Domain models
│   ├── repository/
│   │   ├── image_repository.go  # Database operations
│   │   └── schema.sql       # Database schema
│   └── service/
│       └── image_service.go # Business logic
├── .env.example             # Example environment configuration
└── README.md               # This file
```

## Error Handling

The service includes comprehensive error handling:
- Database connection errors
- API request failures
- Image generation timeouts
- Invalid configurations

All errors are logged with appropriate context for debugging.

## Contributing

1. Fork the repository
2. Create your feature branch
3. Commit your changes
4. Push to the branch
5. Create a new Pull Request